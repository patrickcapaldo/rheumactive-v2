<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RheumActive</title>
    <!-- Bootstrap 5 CSS (Dark Theme) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            background-color: #212529; /* Dark background */
            color: #f8f9fa; /* Light text */
        }
        .navbar {
            background-color: #343a40 !important; /* Darker navbar */
        }
        .card {
            background-color: #343a40; /* Dark card background */
            color: #f8f9fa;
            border-color: #495057;
        }
        .btn-primary {
            background-color: #0dcaf0; /* Cyan-like primary button */
            border-color: #0dcaf0;
        }
        .btn-primary:hover {
            background-color: #0aa3c2;
            border-color: #0aa3c2;
        }
        .btn-secondary {
            background-color: #6c757d; /* Gray secondary button */
            border-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #5a6268;
        }
        .form-select, .form-control {
            background-color: #495057;
            color: #f8f9fa;
            border-color: #6c757d;
        }
        .form-select:focus, .form-control:focus {
            background-color: #495057;
            color: #f8f9fa;
            border-color: #0dcaf0;
            box-shadow: 0 0 0 0.25rem rgba(13, 202, 240, 0.25);
        }
        .form-check-input:checked {
            background-color: #0dcaf0;
            border-color: #0dcaf0;
        }
        .form-check-input:focus {
            border-color: #0dcaf0;
            box-shadow: 0 0 0 0.25rem rgba(13, 202, 240, 0.25);
        }
        .nav-link {
            color: #f8f9fa !important;
        }
        .nav-link.active {
            color: #0dcaf0 !important;
            border-bottom: 2px solid #0dcaf0;
        }
        .icon-ruler, .icon-history {
            width: 1em;
            height: 1em;
            vertical-align: -0.125em;
            fill: currentColor;
            margin-right: 0.5em;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">RheumActive</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#" onclick="showView('mainMenu')">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showView('measure')">Measure</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showView('history')">History</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <!-- Main Menu View -->
        <div id="mainMenu" class="view text-center">
            <h1 class="display-3 fw-bold text-primary">RheumActive</h1>
            <p class="lead text-light">Your personal joint mobility measurement tool.</p>
            <div class="d-grid gap-3 col-6 mx-auto mt-5">
                <button class="btn btn-primary btn-lg" type="button" onclick="showView('measure')">
                    <svg class="icon-ruler" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16V2L2 8l20 14V8l-20 14L2 8l20-6zM12 12v6"></path></svg>
                    Measure Mobility
                </button>
                <button class="btn btn-primary btn-lg" type="button" onclick="showView('history')">
                    <svg class="icon-history" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-9-9 9 9 0 0 1 9 9z"></path></svg>
                    View History
                </button>
            </div>
        </div>

        <!-- Measure View -->
        <div id="measure" class="view" style="display:none;">
            <h2 class="mb-4 text-primary">New Measurement</h2>
            <div class="card p-4 mb-4">
                <div class="mb-3">
                    <label for="jointSelect" class="form-label">Joint</label>
                    <select class="form-select" id="jointSelect">
                        <option value="Elbow">Elbow</option>
                        <option value="Knee">Knee</option>
                        <option value="Shoulder">Shoulder</option>
                        <option value="Hip">Hip</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="exerciseSelect" class="form-label">Exercise</label>
                    <select class="form-select" id="exerciseSelect">
                        <option value="Flexion">Flexion</option>
                        <option value="Extension">Extension</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Duration</label>
                    <div class="btn-group w-100" role="group" aria-label="Duration options">
                        <input type="radio" class="btn-check" name="duration" id="duration15" value="15" autocomplete="off">
                        <label class="btn btn-outline-primary" for="duration15">15s</label>

                        <input type="radio" class="btn-check" name="duration" id="duration30" value="30" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="duration30">30s</label>

                        <input type="radio" class="btn-check" name="duration" id="duration45" value="45" autocomplete="off">
                        <label class="btn btn-outline-primary" for="duration45">45s</label>

                        <input type="radio" class="btn-check" name="duration" id="duration60" value="60" autocomplete="off">
                        <label class="btn btn-outline-primary" for="duration60">60s</label>
                    </div>
                </div>
            </div>

            <div class="text-center mb-4">
                <button id="togglePreviewBtn" class="btn btn-primary btn-lg" type="button">Show Camera Preview</button>
            </div>

            <div id="cameraPreviewSection" class="card p-3 mb-4" style="display:none;">
                <h3 class="text-primary">Live Preview</h3>
                <img id="videoFeed" class="img-fluid rounded mb-3" alt="Live Camera Feed">
                <div class="d-flex justify-content-around align-items-center">
                    <div class="text-center">
                        <h4 class="text-light">Live Angle</h4>
                        <p class="display-4 fw-bold text-primary" id="liveAngle">0.0Â°</p>
                    </div>
                    <button id="beginMeasurementBtn" class="btn btn-success btn-lg" type="button" disabled>Begin Measurement</button>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <button class="btn btn-secondary" type="button" onclick="showView('mainMenu')">Back</button>
            </div>
        </div>

        <!-- History View -->
        <div id="history" class="view" style="display:none;">
            <h2 class="mb-4 text-primary">Measurement History</h2>
            <p class="text-light">History functionality will be implemented here.</p>
            <button class="btn btn-secondary mt-3" type="button" onclick="showView('mainMenu')">Back</button>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        let anglePollingInterval;
        let currentView = 'mainMenu';
        const views = ['mainMenu', 'measure', 'history'];
        let isCameraPreviewVisible = false; // New state variable

        function showView(viewId) {
            views.forEach(id => {
                document.getElementById(id).style.display = (id === viewId) ? 'block' : 'none';
            });
            currentView = viewId;
            updateNavLinks(viewId);

            // When leaving the measure view, ensure camera preview is hidden and polling stops
            if (viewId !== 'measure') {
                const cameraPreviewSection = document.getElementById('cameraPreviewSection');
                const videoFeed = document.getElementById('videoFeed');
                const togglePreviewBtn = document.getElementById('togglePreviewBtn');

                if (isCameraPreviewVisible) {
                    cameraPreviewSection.style.display = 'none';
                    videoFeed.src = '';
                    togglePreviewBtn.innerText = 'Show Camera Preview';
                    isCameraPreviewVisible = false;
                    stopAnglePolling();
                }
            }
        }

        function updateNavLinks(activeViewId) {
            document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.onclick && link.onclick.toString().includes(`'${activeViewId}'`)) {
                    link.classList.add('active');
                }
            });
        }

        // Initial view setup
        showView(currentView);

        // --- Angle Polling ---
        function startAnglePolling() {
            if (!anglePollingInterval) {
                anglePollingInterval = setInterval(fetchAngle, 200); // Poll every 200ms (5 times per second)
            }
        }

        function stopAnglePolling() {
            if (anglePollingInterval) {
                clearInterval(anglePollingInterval);
                anglePollingInterval = null;
            }
        }

        async function fetchAngle() {
            try {
                const response = await fetch('/angle_feed');
                const data = await response.json();
                document.getElementById('liveAngle').innerText = `${data.angle}Â°`;
                // Enable Begin Measurement button if angle is not 0.0 (meaning camera is active)
                if (data.angle !== 0.0) {
                    document.getElementById('beginMeasurementBtn').disabled = false;
                } else {
                    document.getElementById('beginMeasurementBtn').disabled = true;
                }
            } catch (error) {
                console.error('Error fetching angle:', error);
                document.getElementById('liveAngle').innerText = 'N/A';
                document.getElementById('beginMeasurementBtn').disabled = true;
            }
        }

        // --- Camera Preview Toggle Button ---
        document.getElementById('togglePreviewBtn').addEventListener('click', function() {
            const cameraPreviewSection = document.getElementById('cameraPreviewSection');
            const videoFeed = document.getElementById('videoFeed');

            isCameraPreviewVisible = !isCameraPreviewVisible; // Toggle state

            if (isCameraPreviewVisible) {
                cameraPreviewSection.style.display = 'block';
                videoFeed.src = '/video_feed'; // Start the video stream
                this.innerText = 'Hide Camera Preview';
                startAnglePolling(); // Start polling angles when preview is visible
            } else {
                cameraPreviewSection.style.display = 'none';
                videoFeed.src = ''; // Stop the video stream
                this.innerText = 'Show Camera Preview';
                stopAnglePolling(); // Stop polling angles when preview is hidden
            }
        });

        // --- Measurement Logic (Placeholder) ---
        document.getElementById('beginMeasurementBtn').addEventListener('click', function() {
            alert('Measurement started! (Logic to be implemented)');
            // In a real scenario, this would trigger the measurement process
            // and potentially switch to a measurement-in-progress view.
        });

    </script>
</body>
</html>
