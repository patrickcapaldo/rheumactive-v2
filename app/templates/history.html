{% extends 'base.html' %}

{% block title %}Measurement History - RheumActive{% endblock %}

{% block header %}{% endblock %}

{% block head %}
    <style>
        .card {
            background-color: #343a40;
            color: #f8f9fa;
            border: 1px solid #495057;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        .btn-primary {
            background-color: #0dcaf0;
            border-color: #0dcaf0;
        }
        .btn-primary:hover {
            background-color: #0aa3c2;
            border-color: #0aa3c2;
        }
        .form-control, .form-control:focus {
            background-color: #495057;
            color: #f8f9fa;
            border-color: #6c757d;
        }
        .log-item {
            border-bottom: 1px solid #495057;
            padding: 1rem 0;
        }
        .log-item:last-child {
            border-bottom: none;
        }
        .pagination .page-link {
            background-color: #495057;
            color: #f8f9fa;
            border-color: #6c757d;
        }
        .pagination .page-item.active .page-link {
            background-color: #0dcaf0;
            border-color: #0dcaf0;
            color: #212529;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between mt-4">
        <a href="/" class="btn btn-secondary">Back</a>
    </div>

    <h1>Measurement History</h1>

    <!-- Filtering and Pagination Controls -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <form id="filter-form" class="form-inline">
            <select id="joint-filter" class="form-select mr-2">
                <option value="">All Joints</option>
                <option value="left_elbow">Left Elbow</option>
                <option value="right_elbow">Right Elbow</option>
                <option value="left_shoulder">Left Shoulder</option>
                <option value="right_shoulder">Right Shoulder</option>
                <option value="left_knee">Left Knee</option>
                <option value="right_knee">Right Knee</option>
                <option value="left_hip">Left Hip</option>
                <option value="right_hip">Right Hip</option>
            </select>
            <select id="exercise-filter" class="form-select mr-2">
                <option value="">All Exercises</option>
                <option value="Flexion">Flexion</option>
                <option value="Extension">Extension</option>
            </select>
            <input type="date" id="date-filter" class="form-control mr-2">
            <button type="submit" class="btn btn-primary">Filter</button>
        </form>
        <div class="form-inline">
            <label for="per-page-select" class="mr-2">Logs per page:</label>
            <select id="per-page-select" class="form-control">
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="30">30</option>
            </select>
        </div>
    </div>

    <!-- Log List -->
    <div id="log-list"></div>

    <!-- Pagination -->
    <nav>
        <ul id="pagination" class="pagination"></ul>
    </nav>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const logList = document.getElementById("log-list");
            const pagination = document.getElementById("pagination");
            const filterForm = document.getElementById("filter-form");
            const perPageSelect = document.getElementById("per-page-select");

            let currentPage = 1;

            async function fetchLogs(page = 1) {
                const joint = document.getElementById("joint-filter").value;
                const exercise = document.getElementById("exercise-filter").value;
                const date = document.getElementById("date-filter").value;
                const perPage = perPageSelect.value;

                let url = `/api/measurements?page=${page}&per_page=${perPage}`;
                if (joint) url += `&joint=${joint}`;
                if (exercise) url += `&exercise=${exercise}`;
                if (date) url += `&date=${date}`;

                const response = await fetch(url);
                const data = await response.json();

                renderLogs(data.data);
                renderPagination(data.total, data.page, data.per_page);
            }

            function renderLogs(logs) {
                logList.innerHTML = "";
                if (logs.length === 0) {
                    logList.innerHTML = "<p>No measurements found.</p>";
                    return;
                }

                logs.forEach(log => {
                    const logItem = document.createElement("div");
                    logItem.className = "log-item";
                    logItem.innerHTML = `
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">${log.joint} - ${log.exercise}</h5>
                                <h6 class="card-subtitle mb-2 text-muted">${new Date(log.timestamp).toLocaleString()}</h6>
                                <p class="card-text">
                                    <strong>Min Angle:</strong> ${log.min_angle.toFixed(2)}°<br>
                                    <strong>Max Angle:</strong> ${log.max_angle.toFixed(2)}°
                                </p>
                                <a href="/measurement/${log.id}" class="btn btn-primary btn-block">View Details</a>
                            </div>
                        </div>
                    `;
                    logList.appendChild(logItem);
                });
            }

            function renderPagination(total, page, perPage) {
                pagination.innerHTML = "";
                const totalPages = Math.ceil(total / perPage);

                for (let i = 1; i <= totalPages; i++) {
                    const li = document.createElement("li");
                    li.className = `page-item ${i === page ? 'active' : ''}`;
                    const a = document.createElement("a");
                    a.className = "page-link";
                    a.href = "#";
                    a.innerText = i;
                    a.addEventListener("click", (e) => {
                        e.preventDefault();
                        currentPage = i;
                        fetchLogs(i);
                    });
                    li.appendChild(a);
                    pagination.appendChild(li);
                }
            }

            filterForm.addEventListener("submit", (e) => {
                e.preventDefault();
                currentPage = 1;
                fetchLogs(currentPage);
            });

            perPageSelect.addEventListener("change", () => {
                currentPage = 1;
                fetchLogs(currentPage);
            });

            // Initial fetch
            fetchLogs();
        });
    </script>
{% endblock %}